datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider             = "prisma-client-py"
  recursive_type_depth = 5
}

// ========== Enums ==========

enum Role {
  MENTEE
  MENTOR
  PARENT
}

enum Subject {
  KOREAN
  ENGLISH
  MATH
}

enum Grade {
  HIGH1
  HIGH2
  HIGH3
  N_REPEAT
}

enum TaskStatus {
  PENDING
  SUBMITTED
  ANALYZING
  COMPLETED
  FAILED
}

enum SignalLight {
  GREEN
  YELLOW
  RED
}

enum MaterialType {
  COLUMN
  PDF
}

enum AnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum CreatedBy {
  MENTOR
  MENTEE
}

enum SubmissionType {
  TEXT
  DRAWING
}

// ========== Models ==========

model User {
  id           String   @id @default(uuid())
  loginId      String   @unique
  passwordHash String
  role         Role
  name         String
  phone        String
  profileImage String?
  nickname     String?
  avatar       Int      @default(1)  // 아바타 번호 (1~N)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  menteeProfile MenteeProfile?
  mentorProfile MentorProfile?
  parentProfile ParentProfile?
}

model MenteeProfile {
  id             String    @id @default(uuid())
  userId         String    @unique
  user           User      @relation(fields: [userId], references: [id])
  school         String?
  grade          Grade
  subjects       Subject[]
  currentGrades  Json      // { "KOREAN": 3, "ENGLISH": 2, "MATH": 4 }
  targetGrades   Json      // { "KOREAN": 1, "ENGLISH": 1, "MATH": 2 }
  onboardingDone Boolean   @default(false)
  inviteCode     String    @unique @default(uuid())
  createdAt      DateTime  @default(now())

  mentors     MentorMentee[]
  tasks       Task[]
  submissions TaskSubmission[]
  feedbacks   Feedback[]
  comments    DailyComment[]
  parentLinks ParentProfile[]
}

model MentorProfile {
  id                 String    @id @default(uuid())
  userId             String    @unique
  user               User      @relation(fields: [userId], references: [id])
  university         String
  department         String
  subjects           Subject[]
  coachingExperience Boolean   @default(false)
  onboardingDone     Boolean   @default(false)
  createdAt          DateTime  @default(now())

  mentees   MentorMentee[]
  judgments MentorJudgment[]
  feedbacks Feedback[]
}

model ParentProfile {
  id        String        @id @default(uuid())
  userId    String        @unique
  user      User          @relation(fields: [userId], references: [id])
  menteeId  String
  mentee    MenteeProfile @relation(fields: [menteeId], references: [id])
  createdAt DateTime      @default(now())
}

model MentorMentee {
  id        String        @id @default(uuid())
  mentorId  String
  mentor    MentorProfile @relation(fields: [mentorId], references: [id])
  menteeId  String
  mentee    MenteeProfile @relation(fields: [menteeId], references: [id])
  createdAt DateTime      @default(now())

  @@unique([mentorId, menteeId])
}

model Task {
  id                 String        @id @default(uuid())
  menteeId           String
  mentee             MenteeProfile @relation(fields: [menteeId], references: [id])
  createdByMentorId  String?
  date               DateTime      @db.Date
  title              String
  goal               String?
  subject            Subject
  abilityTag         String?
  materialType       MaterialType?
  materialId         String?
  materialUrl        String?
  isLocked           Boolean       @default(false)
  status             TaskStatus    @default(PENDING)
  studyTimeMinutes   Int?
  repeat             Boolean       @default(false)
  repeatDays         String[]
  targetStudyMinutes Int?
  memo               String?
  tags               String[]
  keyPoints          String?
  content            String?
  isBookmarked       Boolean       @default(false)
  createdBy          CreatedBy
  displayOrder       Int           @default(0)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  submissions   TaskSubmission[]
  feedbackItems FeedbackItem[]
  problems      TaskProblem[]
}

model TaskSubmission {
  id               String         @id @default(uuid())
  taskId           String
  task             Task           @relation(fields: [taskId], references: [id])
  menteeId         String
  mentee           MenteeProfile  @relation(fields: [menteeId], references: [id])
  submissionType   SubmissionType
  textContent      String?
  images           String[]
  selfScoreCorrect Int?
  selfScoreTotal   Int?
  wrongQuestions   Int[]
  comment          String?
  submittedAt      DateTime       @default(now())

  analysis         AiAnalysis?
  problemResponses ProblemResponse[]
}

model TaskProblem {
  id            String    @id @default(uuid())
  taskId        String
  task          Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  number        Int
  title         String
  content       String?
  options       Json?
  correctAnswer String?
  displayOrder  Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  responses ProblemResponse[]
}

model ProblemResponse {
  id            String         @id @default(uuid())
  submissionId  String
  submission    TaskSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  problemId     String
  problem       TaskProblem    @relation(fields: [problemId], references: [id], onDelete: Cascade)
  answer        String?
  isCorrect     Boolean?
  textNote      String?
  highlightData Json?
  drawingUrl    String?
  createdAt     DateTime       @default(now())

  @@unique([submissionId, problemId])
}

model AiAnalysis {
  id               String         @id @default(uuid())
  submissionId     String         @unique
  submission       TaskSubmission @relation(fields: [submissionId], references: [id])
  status           AnalysisStatus @default(PENDING)
  signalLight      SignalLight?
  densityScore     Int?
  writingRatio     Float?
  traceTypes       Json?          // { underlineRatio, memoRatio, solutionRatio }
  partDensity      Json?          // [{ partNumber, partTitle, density }]
  pageHeatmap      Json?
  summary          String?        // 1줄 요약
  detailedAnalysis String?        // 상세 분석 (최대 1000자)
  mentorTip        String?
  retryCount       Int            @default(0)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  judgment MentorJudgment?
}

model WrongAnswerSheet {
  id              String   @id @default(uuid())
  submissionId    String
  menteeId        String
  problemId       String
  problemNumber   Int
  problemTitle    String
  originalAnswer  String?
  correctAnswer   String?
  explanation     String?
  relatedConcepts String[]
  practiceUrl     String?
  isCompleted     Boolean  @default(false)
  completedAt     DateTime?
  createdAt       DateTime @default(now())
}

model MentorJudgment {
  id                  String        @id @default(uuid())
  analysisId          String        @unique
  analysis            AiAnalysis    @relation(fields: [analysisId], references: [id])
  mentorId            String
  mentor              MentorProfile @relation(fields: [mentorId], references: [id])
  originalSignalLight SignalLight
  originalScore       Int
  finalSignalLight    SignalLight
  finalScore          Int
  reason              String?
  isModified          Boolean       @default(false)
  confirmedAt         DateTime      @default(now())
}

model Feedback {
  id             String        @id @default(uuid())
  menteeId       String
  mentee         MenteeProfile @relation(fields: [menteeId], references: [id])
  mentorId       String
  mentor         MentorProfile @relation(fields: [mentorId], references: [id])
  date           DateTime      @db.Date
  summary        String?
  isHighlighted  Boolean       @default(false)
  generalComment String?
  sentAt         DateTime      @default(now())
  createdAt      DateTime      @default(now())

  items FeedbackItem[]
}

model FeedbackItem {
  id         String   @id @default(uuid())
  feedbackId String
  feedback   Feedback @relation(fields: [feedbackId], references: [id])
  taskId     String
  task       Task     @relation(fields: [taskId], references: [id])
  detail     String
}

model DailyComment {
  id          String        @id @default(uuid())
  menteeId    String
  mentee      MenteeProfile @relation(fields: [menteeId], references: [id])
  date        DateTime      @db.Date
  content     String
  mentorReply String?
  repliedAt   DateTime?
  createdAt   DateTime      @default(now())
}

model Material {
  id          String       @id @default(uuid())
  title       String
  type        MaterialType
  subject     Subject
  abilityTags String[]
  difficulty  Int?
  contentUrl  String
  createdAt   DateTime     @default(now())
}
