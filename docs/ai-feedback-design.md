# AI 학습 밀도 분석 피드백 설계

> GPT Vision API 연동 시 참고용. 현재 `analysis_service.py`의 mock 로직을 이 설계 기반으로 교체.

## 개요

학생이 제출한 풀이/필기 이미지를 GPT Vision으로 분석하여, **학습 습관의 문제점**을 구체적으로 진단하고 **실행 가능한 개선 방법**을 제시한다.

핵심 원칙: "열심히 했어요/안 했어요"가 아니라 **"이렇게 바꾸면 더 효과적이에요"**

---

## 1. 분석 항목

### 1-1. 필기 흔적 분석 (이미지 기반)

| 항목 | DB 필드 | 설명 |
|---|---|---|
| 필기량 비율 | `writingRatio` (float %) | 빈 공간 대비 실제 작성 비율 |
| 흔적 유형 | `traceTypes` (JSON) | 풀이과정, 밑줄, 메모요약, 오답정리 등 |
| 페이지별 집중도 | `pageHeatmap` (JSON) | 영역별 필기 밀집도, 집중력 저하 패턴 |

**traceTypes 구조:**
```json
{
  "solutionProcess": true,   // 수식 전개, 논리 흐름이 있는 필기
  "underline": true,         // 밑줄/형광펜 단순 표시
  "memo": false,             // 자기 말로 정리한 메모/요약
  "wrongAnswerReview": false  // 틀린 문제 재풀이 흔적
}
```

**pageHeatmap 구조:**
```json
{
  "zones": [
    {"area": "top", "density": 0.8},
    {"area": "middle", "density": 0.5},
    {"area": "bottom", "density": 0.2}
  ],
  "pattern": "DECLINING"  // EVEN | DECLINING | CLUSTERED | SPARSE
}
```

### 1-2. 학습 밀도 점수 (`densityScore`, 0~100)

단순 필기량이 아니라 **효과적 학습 행위**에 가중치 부여:

| 행위 | 가중치 | 이유 |
|---|---|---|
| 풀이 과정 서술 | 높음 (×3) | 사고 과정이 드러남 |
| 오답 재풀이 | 높음 (×3) | 실제 학습 효과가 큼 |
| 자기 말로 요약 | 중간 (×2) | 이해도 확인 가능 |
| 밑줄/형광펜 | 낮음 (×1) | 수동적 학습 |
| 빈 페이지 | 0 | 미참여 |

### 1-3. 신호등 판정 (`signalLight`)

| 등급 | 조건 | 의미 |
|---|---|---|
| GREEN | 밀도 70+ / 풀이과정 있음 / 오답정리 있음 | 효과적 학습 |
| YELLOW | 밀도 40~69 / 부분적 풀이 / 오답정리 미흡 | 개선 필요 |
| RED | 밀도 40 미만 / 단순 표시만 / 빈 공간 많음 | 학습 방법 전환 필요 |

---

## 2. 과목별 맞춤 피드백

### 국어 (KOREAN)
- 지문에 문단별 핵심 문장 표시 여부
- 선지 분석 흔적 (왜 맞고 틀린지 메모)
- 지문 유형별(비문학/문학/화법) 접근법 차이 확인
- 예시: "비문학 지문에서 구조 파악 표시가 부족합니다. 문단별 핵심어를 밑줄치는 습관을 기르세요"

### 영어 (ENGLISH)
- 모르는 어휘 표시 여부
- 구문 분석 흔적 (주어/동사 표시, 관계절 괄호 등)
- 해석 메모 존재 여부
- 예시: "긴 문장에서 구문 분석 없이 해석하려는 경향이 보입니다. 주어-동사를 먼저 찾는 연습을 해보세요"

### 수학 (MATH)
- 풀이 과정 생략 없이 전개했는지
- 검산 흔적 존재 여부
- 공식 활용 과정 기록 여부
- 예시: "답만 적고 풀이를 생략한 문제가 3개 있습니다. 풀이 과정을 적어야 어디서 실수했는지 파악할 수 있어요"

---

## 3. 자기채점 연동 분석

`selfScoreCorrect/Total` + `wrongQuestions` 데이터 활용:

| 상황 | 피드백 방향 |
|---|---|
| 정답률 높음 + 밀도 낮음 | "정답률은 좋지만 풀이 과정이 부족해서, 유사 문제에서 같은 실수를 반복할 수 있어요" |
| 정답률 낮음 + 오답정리 없음 | "틀린 문제에 대한 오답 분석이 없습니다. 왜 틀렸는지 정리하는 것이 가장 효과적인 학습입니다" |
| 정답률 낮음 + 오답정리 있음 | "오답 분석을 하고 있어서 좋습니다. 같은 유형을 반복 풀이하면 더 효과적이에요" |

---

## 4. 시간 효율 분석

`studyTimeMinutes` + `densityScore` 조합:

| 시간 | 밀도 | 피드백 |
|---|---|---|
| 긴 시간 (60분+) | 낮음 (30 이하) | "시간 대비 학습 밀도가 낮습니다. 25분 집중 + 5분 휴식 패턴을 시도해보세요" |
| 짧은 시간 (30분 이하) | 높음 (70+) | "짧은 시간이지만 매우 집중력 있게 학습했어요. 이 패턴을 유지하면서 점차 시간을 늘려보세요" |
| 적절한 시간 | 적절한 밀도 | "학습 시간과 집중도의 균형이 좋습니다" |

---

## 5. GPT Vision 프롬프트 구조

```
[시스템 프롬프트]
너는 고등학생 학습 코칭 AI야.
제출된 학습 이미지를 분석하여 학습 밀도를 평가하고, 구체적인 개선 방법을 제시해.
평가는 반드시 아래 JSON 형식으로 출력해.

[사용자 프롬프트]
과목: {subject}
과제명: {taskTitle}
공부 시간: {studyTimeMinutes}분
목표 공부 시간: {targetStudyMinutes}분
자기채점: {selfScoreCorrect}/{selfScoreTotal}
틀린 문항: {wrongQuestions}

위 이미지는 학생의 풀이/필기 사진입니다. 분석해주세요.

[출력 JSON]
{
  "signalLight": "GREEN" | "YELLOW" | "RED",
  "densityScore": 0~100,
  "writingRatio": 0.0~100.0,
  "traceTypes": {
    "solutionProcess": bool,
    "underline": bool,
    "memo": bool,
    "wrongAnswerReview": bool
  },
  "pageHeatmap": {
    "zones": [{"area": "top"|"middle"|"bottom", "density": 0.0~1.0}],
    "pattern": "EVEN" | "DECLINING" | "CLUSTERED" | "SPARSE"
  },
  "summary": "3~4문장 종합 피드백"
}
```

### summary 작성 규칙
1. 첫 문장: 핵심 관찰 (무엇이 보이는지)
2. 둘째 문장: 문제점 진단 (어떤 습관이 문제인지)
3. 셋째 문장: 구체적 개선 방법 (다음에 어떻게 하면 좋을지)

### summary 예시
- GREEN: "풀이 과정이 체계적으로 작성되어 있고, 오답에 대한 재풀이 흔적도 확인됩니다. 학습 밀도가 높아 효과적으로 공부하고 있어요. 이 패턴을 유지하면서 틀린 유형의 추가 문제를 풀어보면 더 좋겠습니다."
- YELLOW: "글의 구조를 파악하는 연습이 필요합니다. 문단별 핵심어를 밑줄치는 습관을 기르세요. 특히 비교/대조 유형에서 핵심 논점을 놓친 부분이 있었어요."
- RED: "빈 공간이 많고 풀이 과정 없이 답만 적혀 있습니다. 이렇게 하면 같은 실수를 반복하게 됩니다. 오답 노트를 작성할 때 '왜 틀렸는지' 원인을 함께 적어보세요."

---

## 6. 구현 시 수정 파일

| 파일 | 변경 내용 |
|---|---|
| `app/services/analysis_service.py` | `run_analysis_background()` → GPT Vision API 호출로 교체 |
| `app/core/config.py` (또는 `.env`) | `OPENAI_API_KEY` 환경변수 추가 |
| `requirements.txt` | `openai` 패키지 추가 |

### 현재 mock 로직 위치
`app/services/analysis_service.py` → `run_analysis_background()` 함수에서 random 값 생성 중.
이 함수만 GPT Vision 호출로 교체하면 됨.
